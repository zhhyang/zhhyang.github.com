{"componentChunkName":"component---src-templates-blog-post-js","path":"/react-ssr-auth/","result":{"data":{"site":{"siteMetadata":{"title":"Freeman çš„åšå®¢"}},"markdownRemark":{"id":"6253dbdc-2162-5f1b-ae91-7a3946e94169","excerpt":"åœ¨ä½¿ç”¨Reactæ„å»ºåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•åˆ¤æ–­å½“å‰çš„ç™»å½•çŠ¶æ€ï¼Œæ˜¯æ¯ä¸ªåº”ç”¨éƒ½è¦é‡åˆ°çš„é—®é¢˜ï¼Œè€ŒClientç«¯æ¸²æŸ“ï¼Œå¸¸ç”¨çš„JWTæ¨¡å¼ï¼Œå¯¹äºtokençš„ä¿å­˜ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¿å­˜åœ¨localStorageä¸­ï¼Œè€Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸­ï¼Œæ˜¯æ²¡æœ‰localStorageçš„å®šä¹‰çš„ æ—¢ç„¶æˆ‘ä»¬æ— æ³•ä»localStorageâ€¦","html":"<p>åœ¨ä½¿ç”¨Reactæ„å»ºåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•åˆ¤æ–­å½“å‰çš„ç™»å½•çŠ¶æ€ï¼Œæ˜¯æ¯ä¸ªåº”ç”¨éƒ½è¦é‡åˆ°çš„é—®é¢˜ï¼Œè€ŒClientç«¯æ¸²æŸ“ï¼Œå¸¸ç”¨çš„JWTæ¨¡å¼ï¼Œå¯¹äºtokençš„ä¿å­˜ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¿å­˜åœ¨localStorageä¸­ï¼Œè€Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸­ï¼Œæ˜¯æ²¡æœ‰localStorageçš„å®šä¹‰çš„</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> typeof localStorage === &#39;undefined&#39; // true</code></pre></div>\n<p>æ—¢ç„¶æˆ‘ä»¬æ— æ³•ä»localStorageä¸­è·å–æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªèƒ½ä»Cookieä¸­è·å–</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    //after login \n    cookie.save(&#39;token&#39;, token)</code></pre></div>\n<p>åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„expressåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¦å¼•å…¥ <a href=\"https://github.com/expressjs/cookie-parser\">cookie-parseræ¨¡å—</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const express = require(&#39;express&#39;)\nconst cookieParser = require(&#39;cookie-parser&#39;) ;\nconst serverRender = require(&#39;./server.js&#39;)\n\nconst app = express()\n\napp.use(cookieParser())\n\n//other codes  \n\napp.get(&#39;*&#39;, function (req, res, next) {\n    serverRender.default(req, res);\n})\napp.listen(port, function(err) {\n    if (err) {\n        console.error(err)\n    } else {\n        console.info(&quot;==&gt; ğŸŒ  Listening on port %s. Open up http://localhost:%s/ in your browser.&quot;, port, port)\n    }\n})</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import React from &#39;react&#39;\nimport { renderToString } from &#39;react-dom/server&#39;\nimport { RouterContext, match, createMemoryHistory } from &#39;react-router&#39;\nimport configureStore from &#39;../store/configureStore&#39;\nimport routes from &#39;../routes&#39;\n\nexport default function render (req, res) {\n  const token = req.cookies[&#39;token&#39;] // get token from req.cookies\n  let initStore = {}\n  if (token &amp;&amp; isExp(token)) { // token å­˜åœ¨å¹¶ä¸”æ˜¯æœ‰æ•ˆæœªè¶…æ—¶çš„\n    initStore = {user: {token: token}}\n  }\n  const history = createMemoryHistory()\n  const store = configureStore(initStore, history)\n\n  match({routes: routes(store), location: req.url}, (error, redirectLocation, renderProps) =&gt; {\n    // other codes \n  })\n\n}</code></pre></div>\n<p>ä¸Šè¿°ä»£ç ä¸­å…³é”®çš„éƒ¨åˆ†å°±æ˜¯expressåº”ç”¨ä¸­ä½¿ç”¨cookie-parseæ¨¡å—æŠŠcookieæ”¾åˆ°req.cookiesä¸­ï¼Œåœ¨è¯·æ±‚ä¸­å†ä»req.cookiesä¸­è·å–tokenï¼Œ\nè¿™æ—¶å€™æ ¡éªŒtokenæ˜¯å¦æœ‰æ•ˆã€‚æœ‰æ•ˆåˆ™æŠŠtokenå­˜æ”¾åˆ°åˆå§‹çš„storeä¸­</p>\n<p>ä¸‹ä¸€æ­¥åˆ™æ˜¯åœ¨è·¯ç”±ä¸­æ·»åŠ ç™»å½•éªŒè¯é’©å­</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import React from &#39;react&#39;\nimport { Route, IndexRoute } from &#39;react-router&#39;\nimport { redirectToLogin, redirectToBack,isExp } from &#39;./utils/userUtils&#39;\nimport { isClient } from &#39;./utils&#39;\nimport App from &#39;./containers/App&#39;\nimport Login from &#39;./views/login&#39;\nimport Index from &#39;./views/Index&#39;\nimport NotFound from &#39;./components/NotFound&#39;\nimport Mine from &#39;./views/Mine&#39;\n\nexport default (store) =&gt; {\n\n  const serverRequireAuth = (nextState, replace) =&gt; {\n\n    const {user: {token}} = store.getState()\n    if (!token || !isExp(token)) {\n      replace(&#39;/login&#39;)\n    }\n  }\n\n  const serverRedirectAuth = (nextState, replace) =&gt; {\n    const {user: {token}} = store.getState()\n    if (token &amp;&amp; isExp(token)) {\n      replace(&#39;/&#39;)\n    }\n  }\n  //å®¢æˆ·ç«¯æ¸²æŸ“å’ŒæœåŠ¡ç«¯æ¸²æŸ“çš„æ ¡éªŒæ–¹å¼å¯èƒ½ä¼šä¸åŒ\n  const requireAuth = isClient() ? redirectToLogin : serverRequireAuth\n  const redirectAuth = isClient() ? redirectToBack : serverRedirectAuth\n\n  return (\n    &lt;Route path=&quot;/&quot; component={App}&gt;\n      &lt;IndexRoute component={Index}/&gt;\n      &lt;Route path=&quot;/login&quot; component={Login} onEnter={redirectAuth}/&gt;\n      &lt;Route path=&quot;mine&quot; component={Mine} onEnter={requireAuth}/&gt;\n      &lt;Route path=&quot;*&quot; component={NotFound}/&gt;\n    &lt;/Route&gt;\n  )\n}</code></pre></div>\n<p>å®¢æˆ·ç«¯åˆ¤æ–­ç™»å½•çŠ¶æ€çš„å‡½æ•°</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import jwtDecode from &#39;jwt-decode&#39;\nimport moment from &#39;moment&#39;\nimport { getCookie, setCookie, removeCookie} from &#39;./authService&#39;\n\nconst getInfoFromToken = (token) =&gt; {\n  return jwtDecode(token)\n}\n\nfunction checkTokenExpDiff (token) {\n  let tokenPayload = getInfoFromToken(token)\n  let expiry = moment.unix(tokenPayload.exp)\n  return expiry.diff(moment(), &#39;seconds&#39;)\n}\n/**\n * æ˜¯å¦ç™»å½•\n * token å­˜åœ¨ï¼Œå¹¶ä¸”æœ‰æ•ˆæœŸ &gt; 0ç§’\n * @returns {boolean} å·²ç»ç™»å½•è¿”å›trueï¼Œå¦åˆ™è¿”å›false\n */\nconst isLogin = function () {\n  const apiToken = getCookie(&#39;token&#39;)\n  return apiToken &amp;&amp; isExp(apiToken)\n}\n/**\n *\n * @param apiToken\n * @return {boolean} tokenæœ‰æ•ˆè¿”å›trueï¼Œå¦åˆ™è¿”å›false\n */\nconst isExp = function (apiToken) {\n  return checkTokenExpDiff(apiToken) &gt; 0\n}\n\n\nconst redirectToBack = (nextState, replace) =&gt; {\n  //å·²ç»ç™»å½•åˆ™ä¸è¿›å…¥\n  if (isLogin()) {\n    replace(&#39;/&#39;)\n  }\n}\nconst redirectToLogin = (nextState, replace) =&gt; {\n  if (!isLogin()) {\n    replace(&#39;/login&#39;)\n  }\n}\n\nexport {\n  redirectToLogin,\n  redirectToBack,\n}</code></pre></div>","frontmatter":{"title":"ReactæœåŠ¡ç«¯æ¸²æŸ“å¦‚ä½•è¯»å–ç™»å½•çŠ¶æ€","date":"May 06, 2015","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react-ssr-auth/","previous":{"fields":{"slug":"/eslint-get-started/ESLintçš„ä½¿ç”¨/"},"frontmatter":{"title":"ESLintçš„ä½¿ç”¨"}},"next":{"fields":{"slug":"/new-beginnings/"},"frontmatter":{"title":"New Beginnings"}}}}}